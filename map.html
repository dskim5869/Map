<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>아이나비 지도</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    /* 지도 컨테이너의 id가 "map" -> "map_canvas"로 변경되었으므로 스타일도 변경 */
    html, body, #map_canvas { width:100%; height:100%; margin:0; padding:0; background:#e0e0e0; }
  </style>
</head>
<body>
  <!-- 지도 컨테이너의 id가 "map" -> "map_canvas"로 변경되었으므로 HTML도 변경 -->
  <div id="map_canvas"></div> 

  <script>
    // 전역 변수로 지도 객체 선언 (Unity에서 제어할 수 있도록)
    var map; 

    // 아이나비 지도 SDK 로드 시 `callback=initMap`에 의해 자동으로 호출되는 함수
    function initMap() {
        console.log("map.html: initMap() 콜백 함수 호출됨 (SDK 로드 완료).");
        uniwebview.sendMessage("MapHtmlLoaded?data=InaviSDK_Loaded");
    }

    // ★★★ Unity에서 호출될 지도를 초기화하고 중심을 설정하는 함수 ★★★
    // Unity의 MapWebViewManager.cs에서 EvaluateJavaScript를 통해 호출됩니다.
    // initialLat, initialLon을 받아 지도의 초기 중심에 반영합니다.
    function initializeMap(appKey, initialLat, initialLon, initialZoom) {
        console.log("map.html: initializeMap() Unity로부터 호출됨. AppKey:", appKey, "위도:", initialLat, "경도:", initialLon, "줌:", initialZoom);

        // 아이나비 지도 객체 생성 (전역 변수 map에 할당)
        map = new inavi.maps.Map({
            // ★★★ Unity에서 전달받은 위도(initialLat)와 경도(initialLon)를 지도의 중심에 사용 ★★★
            center: new inavi.maps.LatLng(parseFloat(initialLat), parseFloat(initialLon)),
            container: "map_canvas", // 지도 컨테이너 ID
            zoom: parseInt(initialZoom) // Unity에서 전달받은 초기 줌 레벨 사용
        });

        // 지도가 초기화 완료되면 Unity로 메시지 전송
        // `map.on("init", ...)` 이벤트는 아이나비 지도 객체가 완전히 초기화되었을 때 발생합니다.
        map.on("init", function() {
            console.log("map.html: 아이나비 지도 객체 초기화 완료! 'init' 이벤트 발생.");
            // Unity로 초기화 완료 메시지 전송 (UniWebView의 sendMessage 함수 사용)
            uniwebview.sendMessage("MapInitialized?data=Map_is_ready");
        });

        // 지도 초기화 중 오류 발생 시 Unity로 메시지 전송
        map.on("error", function(e) {
            console.error("map.html: 아이나비 지도 초기화 오류 발생:", e);
            // Unity로 오류 메시지 전송 (UniWebView의 sendMessage 함수 사용)
            uniwebview.sendMessage("MapError?data=" + (e.message || "Unknown map error"));
        });
    }

    // ★★★ 기타 불필요한 JavaScript 함수는 모두 제거되었습니다. ★★★

  </script>

  <!-- 아이나비 지도 SDK 로드 -->
  <script src="https://imaps.inavi.com/maps/v3.0/appkeys/9fa813c10de1d52637c4fb13cc8d566fd99f468c/maps?callback=initMap"></script>
</body>
</html>
